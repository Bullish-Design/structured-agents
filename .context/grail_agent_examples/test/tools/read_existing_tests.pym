from grail import Input, external

node_text_input: str | None = Input("node_text", default=None)
target_file_input: str | None = Input("target_file", default=None)


@external
async def read_file(path: str) -> str:
    """Read the text contents of a file."""
    ...


@external
async def file_exists(path: str) -> bool:
    """Check if a file or directory exists."""
    ...


async def _read_optional(path: str) -> str | None:
    if await file_exists(path=path):
        return await read_file(path=path)
    return None


async def _resolve_target_file() -> str | None:
    if target_file_input:
        return target_file_input.strip()
    stored = await _read_optional(path=".remora/target_file")
    if stored:
        return stored.strip()
    return None


def _default_test_path(target_file: str) -> str:
    filename = target_file.split("/")[-1]
    module_name = filename.rsplit(".", 1)[0]
    return f"tests/test_{module_name}.py"


try:
    _ = node_text_input
    target_file = await _resolve_target_file()
    if not target_file:
        raise ValueError("Target file not found for tests.")
    test_path = _default_test_path(target_file)
    if not await file_exists(path=test_path):
        raw_result = {"content": "", "path": None}
        result = {
            "result": raw_result,
            "summary": "No existing tests found",
            "knowledge_delta": {
                "existing_tests_present": False,
                "existing_tests_path": None,
            },
            "outcome": "partial",
        }
    else:
        content = await read_file(path=test_path)
        raw_result = {"content": content, "path": test_path}
        result = {
            "result": raw_result,
            "summary": f"Loaded existing tests from {test_path}",
            "knowledge_delta": {
                "existing_tests_present": True,
                "existing_tests_path": test_path,
            },
            "outcome": "success",
        }
except Exception as exc:
    result = {
        "result": None,
        "summary": f"Error: {exc}",
        "knowledge_delta": {},
        "outcome": "error",
        "error": str(exc),
    }

result
