from grail import Input, external

state_dir: str = Input("state_dir", description="Directory for workspace state files")
style: str = Input("style", description="Formatting style", default="plain")

@external
async def ensure_dir(path: str) -> None:
    ...

@external
async def list_dir(path: str) -> list[str]:
    ...

@external
async def read_file(path: str) -> str:
    ...

await ensure_dir(state_dir)
entries: list[dict[str, str]] = []
files = sorted(await list_dir(state_dir))
for filename in files:
    if not filename.endswith(".txt"):
        continue
    filepath = f"{state_dir}/{filename}"
    text = await read_file(filepath)
    data: dict[str, str] = {}
    for line in text.splitlines():
        if ":" in line:
            key, value = line.split(":", 1)
            data[key] = value
    data["name"] = filename[:-4]
    entries.append(data)

if entries:
    summary_lines = [f"Found {len(entries)} entries:"]
    for entry in entries:
        summary_lines.append(
            f"- {entry['name']}: status={entry.get('status', 'unknown')} priority={entry.get('priority', 'none')}"
        )
    summary = "\n".join(summary_lines)
else:
    summary = "No workspace entries found yet."

tool_call = {
    "name": "format_summary",
    "arguments": {"raw_summary": summary, "style": style},
}
result = {
    "summary": summary,
    "nested_tool_call": tool_call,
    "count": len(entries),
}
result
